\chapter{Comunicando Paramics con OMNeT++ mediante TraCI}

\section{Paramics}
\section{OMNeT++}
\section{TraCI}
TraCI (\textbf{Tra}ffic \textbf{C}ontrol \textbf{I}nterface) es una arquitectura para la interacción con simuladores de redes de transporte, cuyo principal propósito es facilitar el diseño y la implementación de simulaciones de Sistemas de Transporte Inteligente \cite{traci}. Proporciona una interfaz unificada que permite no sólo la obtención de datos desde la simulación de transporte, sino que también permite el control directo sobre la ejecución de ésta y provee métodos para la modificación del comportamiento de sus componentes. Así, TraCI permite a un agente externo (como, por ejemplo, un simulador de redes) comunicarse de manera bidireccional con la simulación de la red de transporte, posibilitando un desarrollo dinámico de dicha simulación en reacción a estímulos externos.

Hoy en día, dicha arquitectura se encuentra integrada con SUMO, y se utiliza en conjunto con simuladores de redes de comunicación inalámbrica como OMNeT++ y NS2 para la simulación y estudio de Sistemas de Transporte Inteligente.

\subsection{Diseño}

TraCI se basa en una arquitectura cliente-servidor, en la cual el simulador de redes de transporte asume el rol de un servidor pasivo que espera comandos desde un cliente activo. Define además un protocolo de comunicaciones de capa de aplicación para la transmisión de comandos e información entre servidor y cliente mediante un \emph{socket} TCP.

La figura \ref{fig:traci_msg} ilustra las composiciones de mensajes TraCI para comandos (cliente $\rightarrow$ servidor), y para respuestas (servidor $\rightarrow$ cliente). Ambas comparten una estructura básica idéntica; una cabecera de 32 bits que indica el largo del mensaje seguida de una cantidad arbitraria de comandos/respuestas.
Para el caso de los comandos, son todos idénticos en su estructura; los primeros dos bytes corresponden al largo del comando y su identificador, respectivamente, seguidos de los parámetros de dicho comando. En el caso de que el largo del comando sobrepase los 255 bits, se fija el byte del largo en $0$ y se agrega un campo adicional de 32 bits que indica el largo extendido del comando.

\begin{figure}[hb]
    %\centering
    \begin{subfigure}{.3\textwidth}
        \centering
            \begin{bytefield}{16}
            \bitheader{0,7,8,15} \\
            \begin{rightwordgroup}{Cabecera}
                \wordbox{2}{Largo del mensaje, incluyendo la cabecera}
            \end{rightwordgroup} \\
            \begin{rightwordgroup}{Comando 0}
                \bitbox{8}{Largo} & \bitbox{8}{ID Comando} \\
                \wordbox{1}{Parámetros del Comando}
            \end{rightwordgroup} \\
            \begin{rightwordgroup}{Comando 1\\(Ejemplo\\largo ext.)}
                \bitbox{8}{0x00} & \bitbox[lrt]{8}{}\\
                \wordbox[lr]{1}{Largo extendido (32 bits)}\\
                \bitbox[lrb]{8}{} & \bitbox{8}{ID Comando} \\
                \wordbox{1}{Parámetros del Comando}
            \end{rightwordgroup} \\
            \wordbox[]{1}{$\vdots$} \\[1ex]
            \begin{rightwordgroup}{Comando n}
                \bitbox{8}{Largo} & \bitbox{8}{ID Comando} \\
                \wordbox{1}{Parámetros del Comando}
            \end{rightwordgroup} \\
        \end{bytefield}
        \caption{Comandos}
        \label{fig:traci_msg:command}
    \end{subfigure}\hspace{0.2\textwidth}%
    \begin{subfigure}{.3\textwidth}
        \centering
        \begin{bytefield}{16}
            \bitheader{0,7,8,15} \\
            \begin{rightwordgroup}{Cabecera}
                \wordbox{2}{Largo del mensaje, incluyendo la cabecera}
            \end{rightwordgroup} \\
            \begin{rightwordgroup}{Estatus\\Comando 0}
                \bitbox{8}{Largo} & \bitbox{8}{ID Comando} \\
                \bitbox{8}{Estatus} & \bitbox[lrt]{8}{} \\
                \wordbox[lrb]{1}{Descripción}
            \end{rightwordgroup}\\
            \begin{rightwordgroup}{Respuesta\\Comando 0\\(Opcional)}
                \bitbox{8}{Largo} & \bitbox{8}{ID Respuesta} \\
                \wordbox{2}{Respuesta a comando}
            \end{rightwordgroup} \\
%            \begin{rightwordgroup}{Comando 1}
%                \bitbox{8}{0x00} & \bitbox[lrt]{8}{}\\
%                \wordbox[lr]{1}{Largo extendido (32 bits)}\\
%                \bitbox[lrb]{8}{} & \bitbox{8}{Identificador} \\
%                \wordbox{1}{Parámetros del Comando}
%            \end{rightwordgroup} \\
            \wordbox[]{1}{$\vdots$} \\[1ex]
            \begin{rightwordgroup}{Estatus\\Comando n}
                \bitbox{8}{Largo} & \bitbox{8}{ID Comando} \\
                \bitbox{8}{Estatus} & \bitbox[lrt]{8}{} \\
                \wordbox[lrb]{1}{Descripción}
            \end{rightwordgroup} \\
        \end{bytefield}
        \caption{Respuesta}
        \label{fig:traci_msg:response}
    \end{subfigure}
    \caption{Formatos de mensajes TraCI}  
    \label{fig:traci_msg}  
\end{figure}
